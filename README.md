# React Native BLE with XState Demo

A React Native (Expo) application demonstrating how **XState** can simplify complex Bluetooth Low Energy (BLE) communication flows. This project showcases a clean, maintainable state machine architecture for handling BLE operations including scanning, connecting, service discovery, and characteristic read/write operations.

## Purpose

BLE communication involves complex state management with multiple asynchronous operations, error handling, and edge cases (connection loss, permission denials, Bluetooth state changes, etc.). This project demonstrates how XState state machines can:

- **Simplify complex async flows** - Handle scanning, connecting, and data exchange in a predictable manner
- **Manage error states gracefully** - Automatic recovery and retry mechanisms
- **Provide clear state visibility** - Know exactly what state your BLE connection is in
- **Handle edge cases** - Connection loss, Bluetooth off, permission denied, etc.

## Architecture

```
app/bluetooth/
â”œâ”€â”€ constants.ts           # BLE UUIDs and storage keys
â”œâ”€â”€ state-machine/
â”‚   â”œâ”€â”€ actors/            # XState actors (async operations)
â”‚   â”‚   â”œâ”€â”€ initializeBle.ts
â”‚   â”‚   â”œâ”€â”€ scanForDevices.ts
â”‚   â”‚   â”œâ”€â”€ scanListener.ts
â”‚   â”‚   â”œâ”€â”€ connectAndSetup.ts
â”‚   â”‚   â”œâ”€â”€ connectedListener.ts
â”‚   â”‚   â”œâ”€â”€ writeLedState.ts
â”‚   â”‚   â”œâ”€â”€ readButtonState.ts
â”‚   â”‚   â””â”€â”€ disconnectFromDevice.ts
â”‚   â”œâ”€â”€ types/             # TypeScript types
â”‚   â”‚   â”œâ”€â”€ bleContext.ts
â”‚   â”‚   â””â”€â”€ bleEvent.ts
â”‚   â”œâ”€â”€ ble-machine.ts     # Main XState machine definition
â”‚   â”œâ”€â”€ selectors.ts       # State selectors for React
â”‚   â”œâ”€â”€ useBluetooth.ts    # React hook for BLE operations
â”‚   â””â”€â”€ index.ts           # Barrel exports
â””â”€â”€ ui/
    â””â”€â”€ index.tsx          # UI component
```

## State Machine States

```
idle â†’ init â†’ scanning â†’ connecting â†’ connected
         â†‘        â†‘           â†‘           â†“
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    (on error/disconnect)
```

- **idle** - Waiting for user to start BLE
- **init** - Checking permissions, starting BLE, loading stored device
- **waitingForBluetooth** - Waiting for Bluetooth to be enabled (auto-retry)
- **scanning** - Scanning for LBS (LED Button Service) devices
- **connecting** - Connecting to device, discovering services, setting up notifications
- **connected** - Connected and ready for characteristic operations
  - **ready** - Idle connected state
  - **togglingLed** - Writing LED characteristic
  - **readingButton** - Reading button characteristic
  - **disconnecting** - Disconnecting from device

## LBS (LED Button Service)

This demo uses the Nordic LED Button Service (LBS) GATT profile:

| Name | UUID |
|------|------|
| LBS Service | `00001523-1212-EFDE-1523-785FEABCD123` |
| Button Characteristic | `00001524-1212-EFDE-1523-785FEABCD123` |
| LED Characteristic | `00001525-1212-EFDE-1523-785FEABCD123` |

## Peripheral Device

For testing, use the **MyPeripheral** Swift app as the BLE peripheral:

ðŸ‘‰ **[SwiftCoreBluetoothDemo/MyPeripheral](https://github.com/BMR11/SwiftCoreBluetoothDemo/tree/main/MyPeripheral)**

This can run on:
- macOS (as a Mac app)
- iOS (as an iOS app)

The peripheral advertises the LBS service and allows the central (this React Native app) to:
- Read/subscribe to button state notifications
- Write to LED characteristic to toggle LED state

## Demo
[![Youtube Video](https://github.com/user-attachments/assets/2040e418-e49f-4203-a437-4c7cbdba3c2e)](https://youtu.be/E6Kt0G-f22c)
<!-- Generated by https://t.cuts.so/github/video -->

## Setup

### Prerequisites

- Node.js 18+
- Android Studio (for Android development)
- Xcode (for iOS development)
- A physical Android/iOS device (BLE doesn't work on emulators/simulators)
- The MyPeripheral app running on macOS or iOS

### Installation

1. Clone the repository:
   ```bash
   git clone https://github.com/your-repo/RN-bluetooth-state-with-xstate.git
   cd rn-ble-xstate-demo
   ```

2. Install dependencies:
   ```bash
   npm install
   ```

3. For Android, create a development build:
   ```bash
   npx expo run:android
   ```

4. For iOS, create a development build:
   ```bash
   npx expo run:ios
   ```

> **Note:** Expo Go does not support native BLE modules. You must use a development build.

## Usage

1. **Start the Peripheral**: Run the MyPeripheral app on your Mac or iOS device

2. **Start the Central**: Launch this React Native app on your Android/iOS device

3. **Connect**:
   - Press "Start BLE" to initialize Bluetooth and request permissions
   - The app will scan for devices advertising the LBS service
   - Tap a device to connect
   - Once connected, you can:
     - See the button state from the peripheral
     - Toggle the LED on the peripheral
     - Read the current button state

4. **Auto-reconnect**: The app stores the last connected device and will attempt to reconnect on next launch

## Testing

This project was **tested on Android** as the central device. iOS should also work but has not been extensively tested.

### Test Scenarios

- âœ… Scan for LBS devices
- âœ… Connect to peripheral
- âœ… Service discovery
- âœ… Read button characteristic
- âœ… Subscribe to button notifications
- âœ… Write LED characteristic
- âœ… Handle unexpected disconnection
- âœ… Handle Bluetooth turned off
- âœ… Auto-reconnect to stored device
- âœ… Permission handling (Android 12+)

## Key Dependencies

| Package | Version | Purpose |
|---------|---------|---------|
| xstate | ^5.25.0 | State machine library |
| @xstate/react | ^6.0.0 | React bindings for XState |
| react-native-ble-manager | ^12.4.1 | BLE operations |
| @react-native-async-storage/async-storage | 2.2.0 | Persist device ID |
| expo | ~54.0.29 | React Native framework |

## XState Patterns Used

### Actors (fromPromise)
Async operations like connecting, reading, writing are modeled as promise-based actors:

```typescript
const connectAndSetup = fromPromise<{ buttonState: boolean }, { deviceId: string }>(
  async ({ input }) => {
    await BleManager.connect(input.deviceId);
    // ... service discovery, notifications setup
    return { buttonState };
  }
);
```

### Callback Actors (fromCallback)
Event listeners are modeled as callback actors with cleanup:

```typescript
const connectedListener = fromCallback<BleEvent>(({ sendBack }) => {
  const listener = BleManager.onDisconnectPeripheral(() => {
    sendBack({ type: 'CONNECTION_LOST', reason: 'Device disconnected' });
  });
  return () => listener.remove(); // Cleanup
});
```

### Selectors
React components use selectors to access state:

```typescript
const isConnected = useSelector(actor, selectIsConnected);
const deviceName = useSelector(actor, selectDeviceName);
const error = useSelector(actor, selectError);
```

## License

MIT

## Contributing

Contributions are welcome! Please open an issue or submit a pull request.
